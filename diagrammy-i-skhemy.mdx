---
title: "Диаграммы и схемы"
---
Визуальные представления процессов и связей в системе.

## 1. Процесс регистрации пользователя

```mermaid
flowchart TD
    A["👤 Пользователь открывает Chat Bridge"] --> B["📱 Вводит номер телефона<br/>+7 999 123-45-67"]
    B --> C["📨 Система отправляет SMS код<br/>(действителен 5 минут)"]
    C --> D["🔐 Пользователь вводит код из SMS"]
    D --> E{"Код верный?"}
    E -->|Да| F["✅ Выдать API token"]
    E -->|Нет| G["❌ Ошибка, повторить"]
    G --> D
    F --> H["🎉 Пользователь вошёл в систему<br/>видит компании"]

    style A fill:#e1f5ff
    style F fill:#c8e6c9
    style G fill:#ffcdd2
    style H fill:#c8e6c9
```

## 2. Процесс настройки компании

```mermaid
stateDiagram-v2
    [*] --> NEW: Компания создана
    NEW --> WAITING_FOR_PROVIDER_SELECTION: Перейти дальше
    WAITING_FOR_PROVIDER_SELECTION --> WAITING_FOR_AVITO_FEED: Выбрать платформы
    WAITING_FOR_AVITO_FEED --> WAITING_FOR_AVITO_ACCESS: Ввести URL фида
    WAITING_FOR_AVITO_ACCESS --> WAITING_FOR_CIAN_ACCESS: OAuth авторизация<br/>(если выбран Cian)
    WAITING_FOR_AVITO_ACCESS --> WAITING_FOR_DOMCLICK_ACCESS: OAuth авторизация<br/>(если выбран Domclick)
    WAITING_FOR_AVITO_ACCESS --> WAITING_FOR_FULL_SYNCHRONIZATION: OAuth авторизация<br/>(если только Avito)
    WAITING_FOR_CIAN_ACCESS --> WAITING_FOR_DOMCLICK_ACCESS: Ввести client_secret<br/>(если выбран Domclick)
    WAITING_FOR_CIAN_ACCESS --> WAITING_FOR_FULL_SYNCHRONIZATION: Ввести client_secret<br/>(если нет Domclick)
    WAITING_FOR_DOMCLICK_ACCESS --> WAITING_FOR_FULL_SYNCHRONIZATION: Ввести оба токена
    WAITING_FOR_FULL_SYNCHRONIZATION --> COMPLETED: Синхронизация завершена ✓
    COMPLETED --> [*]
```

## 3. Структура данных (граф связей)

```mermaid
graph TB
    User["👤 ПОЛЬЗОВАТЕЛЬ<br/>id, phone, name"]
    Company["🏢 КОМПАНИЯ<br/>id, name, status"]
    Ads["📋 ОБЪЯВЛЕНИЯ<br/>(50 шт.)"]
    Chats["💬 ЧАТЫ<br/>(120 чатов)"]
    Messages["💭 СООБЩЕНИЯ<br/>(450 сообщ.)"]
    AvitoToken["🔑 ТОКЕН AVITO<br/>(access + refresh)"]
    MagicLink["🔗 ПРИГЛАСИТЕЛЬНЫЕ ССЫЛКИ<br/>(magic links)"]
    CianToken["🔑 ТОКЕН CIAN"]
    DomclickToken["🔑 ТОКЕН DOMCLICK<br/>(2 токена)"]

    User -->|много-ко-многим<br/>с ролью| Company
    Company --> Ads
    Company --> MagicLink
    Company --> AvitoToken
    Company --> CianToken
    Company --> DomclickToken
    Ads --> Chats
    Chats --> Messages

    style User fill:#bbdefb
    style Company fill:#fff9c4
    style Ads fill:#c8e6c9
    style Chats fill:#f8bbd0
    style Messages fill:#d1c4e9
    style AvitoToken fill:#ffccbc
    style MagicLink fill:#b2dfdb
    style CianToken fill:#ffccbc
    style DomclickToken fill:#ffccbc
```

## 4. Процесс синхронизации

```mermaid
flowchart TD
    A["🚀 НАЧАЛО СИНХРОНИЗАЦИИ"]
    A --> B1["🔴 Avito<br/>XML фид"]
    A --> B2["🔵 Cian<br/>API"]
    A --> B3["🟢 Domclick<br/>API"]

    B1 --> C1["📝 Парсинг XML<br/>объявлений"]
    B2 --> C2["📨 Запрос чатов<br/>из Cian"]
    B3 --> C3["📨 Запрос чатов<br/>из Domclick"]

    C1 --> D["🔗 Привязка объявлений к менеджерам<br/>(по номерам телефонов в XML)"]
    C2 --> D
    C3 --> D

    D --> E["💬 Загрузка сообщений<br/>для каждого чата"]
    E --> F["💾 Сохранение в БД"]
    F --> G["✅ СИНХРОНИЗАЦИЯ ЗАВЕРШЕНА"]

    style A fill:#e1f5ff
    style B1 fill:#ffebee
    style B2 fill:#e3f2fd
    style B3 fill:#e8f5e9
    style G fill:#c8e6c9
```

## 5. Процесс работы с чатом (менеджер)

```mermaid
flowchart TD
    A["👤 Менеджер открывает приложение"]
    A --> B["📋 СПИСОК ЧАТОВ<br/>🔴 Марина новый<br/>⚪ Иван прочитан<br/>⚪ Светлана прочитан"]
    B --> C["👆 Нажимает на чат"]
    C --> D["📌 ДЕТАЛИ ЧАТА<br/>Клиент: Марина<br/>Телефон: +7 999...<br/>Объявление: ул. Пушкина<br/>Менеджер: Иван"]
    D --> E["👁️ Смотрит историю"]
    E --> F["💭 ИСТОРИЯ СООБЩЕНИЙ<br/>14:20 Марина: Квартира в аренду?<br/>14:25 Иван: Да, готова<br/>15:30 Марина: Когда смотреть? 🔴 НЕ ПРОЧИТАНО"]
    F --> G["✍️ Пишет ответ"]
    G --> H["Завтра в 18:00?"]
    H --> I["📤 Отправить ответ"]
    I --> J["💾 Сохранить в Chat Bridge"]
    J --> K["📮 Отправить на платформу<br/>Avito/Cian/Domclick"]
    K --> L["👤 Клиент видит ответ<br/>в своём приложении"]

    style A fill:#e3f2fd
    style B fill:#fff3e0
    style F fill:#fce4ec
    style L fill:#c8e6c9
```

## 6. Матрица доступа (упрощённо)

| Действие | MAINTAINER | RESPONSIBLE | MANAGER |
|----------|:----------:|:-----------:|:-------:|
| Все компании | ✅ | ✅ | ❌ |
| Все объявления | ✅ | ✅ | ❌ |
| Все чаты | ✅ | ✅ | ❌ |
| Свои объявления | ✅ | ✅ | ✅ |
| Свои чаты | ✅ | ✅ | ✅ |
| Приглашать людей | ✅ | ✅ | ❌ |
| Менять интеграции | ✅ | ❌ | ❌ |
| Удалять компанию | ✅ | ❌ | ❌ |
| Менять роли | ✅ | ❌ | ❌ |

## 7. Как система связывает объявления с менеджерами

```mermaid
flowchart TD
    A["📄 XML фид содержит:<br/>feed_id: 123<br/>address: ул. Пушкина, 10<br/>price: 50000<br/>phone: +7 999 111-22-33"]
    A --> B["🔍 Система парсит номер<br/>+7 999 111-22-33"]
    B --> C["🔎 Ищет в БД пользователя<br/>с этим номером"]
    C --> D{"Пользователь<br/>найден?"}
    D -->|Да| E["👤 Петр (MANAGER)"]
    D -->|Нет| F["❓ Не привязано<br/>видит только MAINTAINER"]
    E --> G["👁️ Петр видит объявление<br/>в своей ленте"]
    F --> G

    style A fill:#fff3e0
    style E fill:#c8e6c9
    style F fill:#ffcdd2
    style G fill:#e8f5e9
```

## 8. Жизненный цикл чата

```mermaid
stateDiagram-v2
    [*] --> ClientWriting
    ClientWriting --> SystemSync
    SystemSync --> ManagerView
    ManagerView --> Active
    Active --> ManagerReply
    ManagerReply --> PlatformSync
    PlatformSync --> ClientReceive
    ClientReceive --> Inactive
    Inactive --> [*]

    note right of ClientWriting
        Клиент пишет в Avito
    end note

    note right of SystemSync
        Система загружает
        каждые 15–30 минут
    end note

    note right of ManagerView
        Появляется в ленте
        менеджера
    end note

    note right of Active
        Статус: АКТИВНЫЙ
        Непрочитан
        Требует ответа
    end note

    note right of ManagerReply
        Менеджер видит
        и отвечает
    end note

    note right of PlatformSync
        Ответ отправляется
        на Avito / Cian / Domclick
    end note

    note right of ClientReceive
        Клиент видит
        ответ в приложении
    end note

    note right of Inactive
        Чат становится
        НЕАКТИВНЫМ
        (клиент не пишет)
    end note

```

## 9. Интеграция с платформами

```mermaid
graph TB
    ChatBridge["🎯 Центральная система"]

    Avito["🔴 AVITO"]
    Cian["🔵 CIAN"]
    Domclick["🟢 DOMCLICK"]

    AvitoAPI["OAuth авторизация\nXML Feeds\nAvito API"]
    CianAPI["API Chats\nCian API"]
    DomclickAPI["API Stats\nDomclick API"]

    AvitoData["Объявления\nЧаты\nСообщения"]
    CianData["Чаты\nСообщения"]
    DomclickData["Чаты\nСообщения"]

    ChatBridge --> AvitoAPI
    ChatBridge --> CianAPI
    ChatBridge --> DomclickAPI

    AvitoAPI --> Avito
    CianAPI --> Cian
    DomclickAPI --> Domclick

    Avito --> AvitoData
    Cian --> CianData
    Domclick --> DomclickData

    style ChatBridge fill:#fff3e0,stroke:#ff9800,stroke-width:3px
    style Avito fill:#ffebee
    style Cian fill:#e3f2fd
    style Domclick fill:#e8f5e9
```

## 10. Распределение объявлений в компании

```mermaid
graph TB
    Company["🏢 'Иванов и партнёры'<br/>50 объявлений<br/>120 чатов"]

    Ivan["👑 MAINTAINER: Иван<br/>Видит всё"]
    Sergey["👔 RESPONSIBLE: Сергей<br/>Видит всё"]
    Petr["👨 MANAGER: Петр<br/>(+7 999 111-22-33)<br/>10 объявлений<br/>28 чатов"]
    Masha["👩 MANAGER: Маша<br/>(+7 999 555-66-77)<br/>5 объявлений<br/>19 чатов"]
    Sveta["👩 MANAGER: Света<br/>(+7 999 777-88-99)<br/>35 объявлений<br/>47 чатов"]

    Ad1["📍 ул. Пушкина (3 чата)"]
    Ad2["📍 ул. Лермонтова (5 чатов)"]
    Ad3["📍 ул. Толстого"]
    Ad4["📍 ул. Островского"]
    Ad5["📍 40+ других объявлений"]

    Company --> Ivan
    Company --> Sergey
    Company --> Petr
    Company --> Masha
    Company --> Sveta

    Petr --> Ad1
    Petr --> Ad2

    Masha --> Ad3
    Masha --> Ad4

    Sveta --> Ad5

    style Company fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style Ivan fill:#ffebee,stroke:#c62828
    style Sergey fill:#e3f2fd,stroke:#1565c0
    style Petr fill:#e8f5e9,stroke:#2e7d32
    style Masha fill:#e8f5e9,stroke:#2e7d32
    style Sveta fill:#e8f5e9,stroke:#2e7d32
```
